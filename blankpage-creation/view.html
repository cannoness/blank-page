{{- $exhibit := .Parent "view" -}}
{{- $links := .Data "links" -}}
{{- $streamURL := .Data "streamURL" -}}
{{- $summary := .Data "summary" -}}
{{- $attachmentID := .Data "attachmentId" -}}
{{- $duration := .Data "length"}}
{{- $iconURL := .IconURL -}}
{{- $imageURL := .Data "imageUrl" -}}

{{- if eq "" $iconURL -}}
	{{- $iconURL =  $exhibit.IconURL -}}
{{- end -}}

<style>{{- template "stylesheet" . -}}</style>
<div id="work-{{.StreamID}}" class="page padding-none margin-none">

	<!-- oEmbed: https://oembed.com -->
	<link rel="alternate" type="application/json+oembed" href="{{.OEmbedJSON}}">
	<link rel="alternate" type="text/xml+oembed" href="{{.OEmbedXML}}">

	<!-- Open Graph: https://ogp.me/ -->
	<!-- https://developers.facebook.com/docs/opengraph/music/ -->
	<meta property="og.type" content="music.creation">
	<meta property="og:title" content="{{.Label}}">
	<meta property="og:url" content="{{.Permalink}}">
	<meta property="og:image" content="{{$iconURL}}">
	<meta property="og:site_name" content="{{.DomainLabel}}">
	<meta property="og:description" content="{{.Summary}}">
	<meta property="og:audio" content="{{.Host}}/{{.StreamID}}/attachments/{{$attachmentID}}">
	<meta property="og:music:duration" content="{{$duration}}">
	<meta property="og:music:exhibit" content="{{$exhibit.URL}}">
	<meta property="og:music:exhibit:work" content="{{.Rank}}">
	<meta property="og:music:musician" content="{{.AttributedTo.ProfileURL}}">

	<div class="pos-relative padding">

		<div class="md:flex-row">
			<div class="md:width-32"></div>
			<div class="flex-grow-1">
				<h1 class="margin-vertical-none">
					<span id="work-name">
						<span class="hide-visual">Track Name:</span>
						{{.Label}}
					</span>
					{{- if eq true (.Data "mature") -}}
						<span class="text-light-gray text-xl margin-left" title="Explicit Lyrics" aria-label="Explicit Lyrics">{{icon "mature-fill"}}</span>
					{{- end -}}
				</h1>
				<div class="text-lg margin-top-none">
					<a id="work-attributedTo" href="/@{{$exhibit.AttributedTo.UserID.Hex}}" hx-boost="true" hx-swap="transition:true" class="turboclick">
						<span class="hide-visual">Artist:</span>
						{{$exhibit.AttributedTo.Name}}
					</a> 
					<span aria-hidden="true">&middot;</span>
					<a id="work-exhibit" href="/{{$exhibit.StreamID}}" hx-boost="true" hx-swap="transition:true" class="turboclick">
						<span class="hide-visual">Album:</span>
						{{ $exhibit.Label }}
					</a>
				</div>

				<div class="margin-bottom text-gray">
					{{ if ne nil ($exhibit.Data "year") -}}
						<span id="work-year">
							<span class="hide-visual">Release Date:</span>
							{{$exhibit.Data "year"}}
						</span>
						{{ if ne nil (.Data "length") -}}
							<span aria-hidden="true">&middot;</span>
						{{ end }} 
					{{- end -}}
					<span id="work-length">
						<span class="hide-visual">Play Time:</span>
						{{.Data "length"}}
					</span>
				</div>


				<div class="md:flex-row">
					<a href="{{$iconURL}}" class="piece" rel=”noreferrer target="_SEJ">
						<img class="padding piece" id="piece" src="{{$attachmentID}}" aria-hidden="true">
					</a>
					<div class="text-sm">
						<button hx-get="/{{.StreamID}}/intent?intent=create&content={{.Label | queryEscape}} {{.Permalink}}"><span aria-hidden="true" class="margin-left-xs">{{icon "share"}}</span> Share</button>
						<button hx-get="/{{.StreamID}}/intent?intent=like&object={{.Permalink}}"><span aria-hidden="true" class="margin-left-xs">{{icon "thumbs-up"}}</span> Like</button>
					</div>

				</div>

			</div>
		</div>

		<div class="md:flex-row-reverse">

			<div class="flex-grow-1">

				{{- if ne nil $summary -}}
					<div id="work-description" class="margin-bottom-xl padding-right-xl">{{$summary | text}}</div>
				{{- end -}}
		
			</div>

			<div class="md:width-256 flex-shrink-0 flex-grow-1"></div>
			<div id="work-links" class=" flex-shrink-0">
				<div class="text-sm">Category: {{ .Data "category" }}</div>

				{{- if .Tags.NotEmpty -}}
					<div id="creation-tags">
						{{- range $index, $tag := .Tags -}}
							{{- if eq "Hashtag" $tag.Type}}
							<a href="/works?q=%23{{$tag.Name}}" hx-boost="true" class="tag margin-bottom-sm">#{{$tag.Name}}</a>
							{{- end -}}
						{{- end -}}
					</div>
				{{- end -}}

				{{- if $links.NotEmpty -}}

					<h3>Stream Online</h3>
					{{- range $key, $value := $links -}}
						
						{{- if ne "" $value -}}
							{{- $icon := "music-note-beamed" -}}
							{{- $label := $value -}}

							{{- if eq "AMAZON" $key -}}
								{{- $label = "Amazon Music" -}}
								{{- $icon = "amazon" -}}

							{{- else if eq "APPLE" $key -}}
								{{- $icon = "apple" -}}
								{{- $label = "Apple Music" -}}

							{{- else if eq "BANDCAMP" $key -}}
								{{- $label = "Bandcamp" -}}

							{{- else if eq "GOOGLE" $key -}}
								{{- $label = "Google Play" -}}
								{{- $icon = "google" -}}

							{{- else if eq "IHEARTRADIO" $key -}}
								{{- $label = "iHeartRadio" -}}

							{{- else if eq "PANDORA" $key -}}
								{{- $label = "Pandora" -}}

							{{- else if eq "SPOTIFY" $key -}}
								{{- $label = "Spotify" -}}
								{{- $icon = "spotify" -}}

							{{- else if eq "SOUNDCLOUD" $key -}}
								{{- $label = "SoundCloud" -}}
								{{- $icon = "cloud" -}}

							{{- else if eq "TIDAL" $key -}}
								{{- $label = "Tidal" -}}

							{{- else if eq "YOUTUBE" $key -}}
								{{- $label = "YouTube Music" -}}
								{{- $icon = "youtube" -}}

							{{- else -}}
								{{- $label = domainOnly $value -}}

							{{- end -}}

							<a href="{{$value}}" target="_blank">
								<i class="bi bi-{{$icon}}"></i> {{ $label }}
							</a><br>
						{{- end -}}

					{{- end -}}
					<br>
				{{- end -}}

				{{- if ne nil $streamURL -}}
					<a id="work-video" href="{{$streamURL}}" target="_blank" class="block ellipsis">
						<i class="bi bi-camera-video-fill"></i> Music Video
					</a><br>
				{{- end -}}

				<br>
				{{- if ne nil (.Data "hubber") -}}
					<span id="work-hubber">Artist: {{.Data "hubber"}}</span><br>
				{{- end -}}
			
				{{- $license := .DataString "license"}}l
				{{- if eq "COPYRIGHT" $license -}}
					<div id="work-license">
						<h3 class="margin-top">License</h3>
						<div>
							&copy; Copyright
							{{- if ne nil (.Data "year") }}
								{{.Data "year"}}.
							{{- else -}}
								.
							{{- end }}
							All Rights Reserved.
						</div>
					</div>
				{{- else if ne "" $license -}}
					{{- $licenses := .Dataset "blankpage-exhibit.licenses" -}}
					{{- $licenseInfo := $licenses.Value $license -}}
					<div id="work-license">
						<h3 class="margin-top">License</h3>
						<div>
							<a href="{{$licenseInfo.Href}}" rel="license" class="text-plain" target="_blank">
								{{icon $licenseInfo.Icon}} 
								{{ if ne nil (.Data "year") }}
									{{.Data "year"}}
								{{- end }}
								{{$licenseInfo.Label}}
							</a>
						</div>
					</div>
				{{- end -}}
			</div>

		</div>

		{{- if .UserCan "edit" -}}
			<div class="pos-absolute-top-right text-xs">
				<button hx-get="/{{.StreamID}}/edit">Edit Piece</button>
			</div>

			<div hx-ext="sse" sse-connect="/{{.StreamID}}/sse">
				<div 
					hx-get="/{{.StreamID}}" 
					hx-trigger="sse:{{.StreamID}}, refreshPage from:window" 
					hx-target="#main" 
					hx-swap="innerHTML"
					hx-push-url="false">
				</div>
			</div>
		{{- end -}}
		
	</div>

</div>