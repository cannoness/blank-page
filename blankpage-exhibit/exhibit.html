{{- $streamID := .StreamID -}}
{{- $tags := .Tags -}}
{{- $icon := .IconURL -}}
{{- $creations := .Children.Top120.ByRank.Slice -}}
{{- $canEdit := .UserCan "edit" -}}
{{- $links := .Data "links" -}}
{{- range $index, $creation := $creations -}}
	{{- if not .IconURL -}}
		{{- $icon := $creation.Data.attachmentId -}}
	{{- end -}}
{{- end -}}
{{- $checkoutLabel := first (.Data "checkout label") "Buy Now" -}}

<div id="exhibit-{{.StreamID}}" class="page padding-none margin-none">

	<link rel="stylesheet" type="text/css" href="/{{.StreamID}}/stylesheet?v={{.ETag}}"/>

	<!-- oEmbed: https://oembed.com -->
	<link rel="alternate" type="application/json+oembed" href="{{.OEmbedJSON}}">
	<link rel="alternate" type="text/xml+oembed" href="{{.OEmbedXML}}">

	<!-- Open Graph: https://ogp.me/ -->
	<!-- https://developers.facebook.com/docs/opengraph/music/ -->
	<meta property="og:type" content="music.exhibit">
	<meta property="og:title" content="{{.Label}}">
	<meta property="og:url" content="{{.Permalink}}">
	<meta property="og:image" content="{{.IconURL}}">
	<meta property="og:description" content="{{.Summary}}">
	<meta property="og:site_name" content="{{.DomainLabel}}">
	<meta property="music:release_date" content="{{.Data `year`}}">
	<meta property="music:musician" content="{{.AttributedTo.ProfileURL}}">

	{{- $year := .Data "year" -}}
		{{- range $index, $creation := $creations -}}
		<meta property="music:creation" content="{{$creation.URL}}">
		<meta property="music:creation:work" content="{{$index}}">
	{{- end -}}

	{{- if not .IsPublished -}}
		{{- if $creations.NotEmpty -}}
			<div class="clickable alert-green margin-none" hx-get="/{{.StreamID}}/publish" role="button" style="border-radius:0px;">
				{{icon "check-circle"}} 

				This exhibit IS READY TO PUBLISH on the social web.
				<span class="text-underline">Click here to publish it now</span>
			</div>
		{{- end -}}
	{{- end -}}

	<!-- Header and Info Row -->
	<div class="md:flex-row pos-relative padding">

		{{- if $canEdit -}}
			<div class="pos-absolute-top-right text-sm">
				<button hx-get="/{{.StreamID}}/add-creation">{{icon "plus"}}Add Creation</button>
				<button hx-get="/{{.StreamID}}/edit">Edit Exhibit</button>
				<button hx-get="/{{.StreamID}}/edit-checkout">
					{{- if .StreamHasPrivileges -}}
						{{icon "check"}} Sales Enabled
					{{- else -}}
						Sell Online
					{{- end -}}
				</button>
				{{- if .IsPublished -}}
					<button hx-get="/{{.StreamID}}/unpublish">{{icon "check"}} Published</button>
				{{- else if $creations.NotEmpty -}}
					<button hx-get="/{{.StreamID}}/publish" class="primary">Publish</button>
				{{- end -}}
					
			</div>
		{{- end -}}


		<div hx-get="/{{.StreamID}}/edit" role="button" class="md:width-10% lg:width-20% md:margin-right-md flex-grow-0 flex-shrink-0 margin-bottom-md rounded pos-relative">
			{{- if ne "" .IconURL -}}
				<img id="exhibit-icon" src="{{ .IconURL }}" class="width-100% rounded square" aria-hidden="true" style="view-transition-name: icon-{{.StreamID}};">
			{{- else if $canEdit -}}
				<div class="rounded width-100% square text-center flex-column flex-justify-center flex-align-center text-gray" style="border:solid 1px var(--black)" script="install blockselect()">
					Click here to add exhibit art
				</div>
			{{- end -}}
		</div>

		<form class="flex-grow lg:margin-rigth">
			<h2 id="exhibit-name">
				<span class="hide-visual">Exhibit Name:</span>
				{{.Label}}
			</h2>
			<div class="text-sm margin-top-none">
				<a href="/@{{.ParentID}}" hx-boost="true" hx-swap="transition:true" id="exhibit-attributedTo" aria-label="Artist: {{.AttributedTo.Name}}">
					{{.AttributedTo.Name}}
				</a>
			</div>

			{{- if .IsPublished -}}

				<div class="margin-vertical"></div>
	
				<div id="media-controls" class="margin-vertical-lg">

					{{- if .StreamHasPrivileges -}}
						{{- if .UserHasRole "paid" -}}
							<button hx-get="/{{.StreamID}}/premium-downloads" class="outline">
								{{icon "download"}}
								Download Exhibit
							</button>
						{{- else -}}
							<button hx-get="/{{$streamID}}/checkout" class="outline">
								<span class="htmx-request-hide">{{icon "star"}}</span>
								<span class="htmx-request-show"><span class="spin">{{icon "loading"}}</span></span>
								{{ $checkoutLabel }}
							</button>
						{{- end -}}
					{{- end -}}

				</div>

				<div class="text-sm">
					<button hx-get="/{{.StreamID}}/intent?intent=create&content={{.Label | queryEscape}} {{.Permalink}}"><span aria-hidden="true" class="margin-left-xs">{{icon "share"}}</span> Share</button>
					<button hx-get="/{{.StreamID}}/intent?intent=like&object={{.Permalink}}"><span aria-hidden="true" class="margin-left-xs">{{icon "thumbs-up"}}</span> Like</button>
					<button hx-get="/{{.StreamID}}/intent" aria-label="Manage Accounts">{{icon "more-horizontal"}}</button>
				</div>

			{{- end -}}

		</form>

	</div>
	<!-- Piece List Row -->
	<div class="md:flex-row pos-relative padding">
		<div id="exhibit-notes" class="md:width-20% lg:width-20% md:margin-right-md flex-grow-0 flex-shrink-0 margin-bottom-md rounded pos-relative" tabindex="0">
		{{- if ne "" .Summary -}}
			<h3>Exhibit Notes</h3>
			{{.Summary | markdown}}
		{{- else -}}
			<h3>Exhibit Notes</h3>
			No description given.
		{{- end -}}
		</div>
		{{- if $creations.NotEmpty -}}
			<div id="children" class="flex-grow-1 flex-shrink-1 lg:margin-right columns-3">
				{{- template "children" . -}}
			</div>

		{{- else if $canEdit -}}

			<div class="md:flex-row  padding">
				<div hx-get="/{{.StreamID}}/add-creation" role="button" class="clickable flex-row">
					<div class="margin-horizontal-xs flex-align-self-center link" style="font-size:50px" aria-hidden="true">{{icon "art"}}</div>
					<div class="flex-grow">
						<div class="text-lg bold link nowrap">
							Add the first creation to this exhibit
						</div>
						<div class="text-sm text-gray">You'll need to add at least one creation to this exhibit before you can publish it.</div>
					</div>
				</div>
			</div>
		{{- end -}}

	</div>

	<!-- Links and stuff Row -->
		{{- if $tags.NotEmpty -}}
			<h3>Exhibit Tags</h3>
			<div id="exhibit-tags" class="text-sm margin-bottom-lg">
				{{- range $index, $tag := $tags -}}
					{{- if eq "Hashtag" $tag.Type}}
						<a href="/exhibits?q=%23{{$tag.Name}}" hx-boost="true" class="tag margin-bottom-sm" aria-label="Hashtag: {{$tag.Name}}">#{{$tag.Name}}</a>
					{{- end -}}
				{{- end -}}
			</div>
		{{- else -}}
		<div id="exhibit-tags-empty" class="text-sm margin-bottom-lg"></div>
		{{- end -}}

		{{- if $links.NotEmpty -}}
			<div id="links" class="text-sm margin-bottom-lg">
				<h3>Also On These Sites:</h3>
				{{- range $key, $value := $links -}}

					{{- if ne "" $value -}}
						{{- $icon := "music-note-beamed" -}}
						{{- $label := $value -}}

						{{- if eq "AMAZON" $key -}}
							{{- $label = "Amazon Music" -}}
							{{- $icon = "amazon" -}}

						{{- else if eq "APPLE" $key -}}
							{{- $icon = "apple" -}}
							{{- $label = "Apple Music" -}}

						{{- else if eq "BANDCAMP" $key -}}
							{{- $label = "Bandcamp" -}}

						{{- else if eq "GOOGLE" $key -}}
							{{- $label = "Google Play" -}}
							{{- $icon = "google" -}}

						{{- else if eq "IHEARTRADIO" $key -}}
							{{- $label = "iHeartRadio" -}}

						{{- else if eq "PANDORA" $key -}}
							{{- $label = "Pandora" -}}

						{{- else if eq "SOUNDCLOUD" $key -}}
							{{- $label = "SoundCloud" -}}
							{{- $icon = "cloud" -}}

						{{- else if eq "SPOTIFY" $key -}}
							{{- $label = "Spotify" -}}
							{{- $icon = "spotify" -}}

						{{- else if eq "TIDAL" $key -}}
							{{- $label = "Tidal" -}}

						{{- else if eq "YOUTUBE" $key -}}
							{{- $label = "YouTube Music" -}}
							{{- $icon = "youtube" -}}

						{{- else -}}
							{{- $label = domainOnly $value -}}

						{{- end -}}

						<a href="{{$value}}" class="block ellipsis" target="_blank">
							<i class="bi bi-{{$icon}}"></i> {{ $label }}
						</a>
					{{- end -}}

				{{- end -}}
				</div>
			{{- end -}}

			{{- $uploads := .AttachmentsByCategory "other" -}}
<!--			{{- if or $uploads.NotEmpty $canEdit -}}-->
<!--				<div id="exhibit-attachments" class="margin-bottom-lg">-->
<!--					<div class="flex-row">-->
<!--						<h3 class="flex-grow margin-none">Other Files</h3>-->
<!--					</div>-->

<!--					{{- if $uploads.NotEmpty -}}-->
<!--						<div class="table margin-top-lg">-->
<!--							{{- range $index, $upload := $uploads -}}-->
<!--								<div class="flex-row padding-vertical-sm">-->
<!--									<div class="flex-grow">-->
<!--										<a href="/{{$streamID}}/attachments/{{.AttachmentID.Hex}}" target="_blank" class="ellipsis">{{.Label}}</a><br>-->
<!--										<span class="text-sm text-gray">{{.Description}}</span>-->
<!--									</div>-->
<!--									{{- if $canEdit -}}-->
<!--										<div>-->
<!--											<button hx-get="/{{$streamID}}/edit-upload?attachmentId={{.AttachmentID.Hex}}" title="Edit Attachment" aria-label="Edit Attachment" class="text-xs margin-left-sm">{{icon "more-horizontal"}}</button>-->
<!--										</div>-->
<!--									{{- end -}}-->
<!--								</div>-->
<!--							{{- end -}}-->
<!--						</div>-->
<!--					{{- end -}}-->
<!--				</div>-->
<!--			{{- end -}}-->

			<div id="exhibit-license" class="text-smmargin-bottom-lg">
				{{- $license := .DataString "license"}}
				{{- if eq "COPYRIGHT" $license -}}
					<h3 class="margin-none">License</h3>
					<div>
						&copy; Copyright
						{{- if ne nil (.Data "year") }}
							{{.Data "year"}}.
						{{- else -}}
							.
						{{- end }}
						All Rights Reserved.
					</div>
				{{- else if ne "" $license -}}
					{{- $licenses := .Dataset "blankpage-exhibit.licenses" -}}
					{{- $licenseInfo := $licenses.Value $license -}}
					<h3 class="margin-none">License</h3>
					<div>
						<a href="{{$licenseInfo.Href}}" rel="license" class="text-plain" target="_blank">
							{{icon $licenseInfo.Icon}} 
							{{ if ne nil (.Data "year") }}
								{{.Data "year"}}
							{{- end }}
							{{$licenseInfo.Label}}
						</a>
					</div>
				{{- end -}}
			</div>


<!--		{{- if $creations.NotEmpty -}}-->
<!--&lt;!&ndash;			<script src="/.templates/blankpage-exhibit/javascript" preload></script>&ndash;&gt;-->
<!--&lt;!&ndash;				<script id="playlist" type="application/javascript" data-json='[&ndash;&gt;-->
<!--&lt;!&ndash;					{{- $first := true -}}&ndash;&gt;-->
<!--&lt;!&ndash;					{{- range $index, $creation := $creations -}}&ndash;&gt;-->
<!--&lt;!&ndash;						{{- if ne nil $creation.Data.attachmentId -}}&ndash;&gt;-->
<!--&lt;!&ndash;							{{- if not $first -}},{{- end -}}&ndash;&gt;-->
<!--&lt;!&ndash;							{{- $first = false -}}&ndash;&gt;-->
<!--&lt;!&ndash;							{"url":"/{{$creation.StreamID}}/attachments/{{$creation.Data.attachmentId}}", "title":{{$creation.Label | json}} }&ndash;&gt;-->
<!--&lt;!&ndash;						{{ end -}}&ndash;&gt;-->
<!--&lt;!&ndash;					{{- end -}}&ndash;&gt;-->
<!--&lt;!&ndash;					]'>&ndash;&gt;-->
<!--&lt;!&ndash;					var playlist = JSON.parse(document.getElementById('playlist').dataset.json);&ndash;&gt;-->
<!--			{{- if $canEdit -}}-->

<!--				<script src="/.themes/global/resources/sortable-1.15.0/Sortable.min.js" preload></script>-->

<!--				<script>-->
<!--					new Sortable(document.getElementById("exhibit-works"), {-->
<!--						handle: ".drag-handle",-->
<!--						animation: 150,-->
<!--						whisperClass: 'draggable-whisper'-->
<!--					});-->
<!--				</script>-->

<!--				<style>-->
<!--					.drag-handle {-->
<!--						cursor:grab;-->
<!--					}-->

<!--					.draggable-whisper {-->
<!--						background-color: var(&#45;&#45;gray50);-->
<!--						color:var(&#45;&#45;gray50);-->
<!--						cursor: grabbing;-->
<!--					}-->
<!--				</style>-->
<!--			{{- end -}}-->

<!--		{{- end -}}-->


	{{- if $canEdit -}}

		<div id="stream-refresh-{{.StreamID}}" hx-preserve>

			<div 
				hx-get="/{{.StreamID}}" 
				hx-trigger="refreshPage from:window" 
				hx-push-url="false"
				hx-target="#main"
				hx-swap="innerHTML">
			</div>

			<div 
				hx-get="/{{.StreamID}}" 
				hx-trigger="refreshPage from:window delay:300ms" 
				hx-push-url="false"
				hx-target="#main"
				hx-swap="innerHTML">
			</div>

			<div 
				hx-get="/{{.StreamID}}" 
				hx-trigger="refreshPage from:window delay:600ms" 
				hx-push-url="false"
				hx-target="#main"
				hx-swap="innerHTML">
			</div>

			<div 
				hx-get="/{{.StreamID}}" 
				hx-trigger="refreshPage from:window delay:900ms" 
				hx-push-url="false"
				hx-target="#main"
				hx-swap="innerHTML">
			</div>

			<!--
			<div 
				hx-get="/{{.StreamID}}" 
				hx-trigger="refreshPage from:window delay:1000ms" 
				hx-push-url="false"
				hx-target="#main"
				hx-swap="innerHTML">
			</div>
			-->

			<!--
			<div hx-ext="sse" sse-connect="/{{.StreamID}}/sse">
				<div 
					hx-get="/{{.StreamID}}" 
					hx-target="main"
					hx-swap="innerHTML"
					hx-trigger="sse:{{.StreamID}}" 
					hx-push-url="false">
				</div>
			</div>
			-->

		</div>
	{{- end -}}

</div>